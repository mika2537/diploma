import { MongoClient } from "npm:mongodb";

// ‚öôÔ∏è MongoDB-—Ç—ç–π —Ö–æ–ª–±–æ–≥–¥–æ—Ö
const client = new MongoClient(
  "mongodb+srv://mika:guhbac-guqce9-Syqjum@voting.e2szuse.mongodb.net/"
);
await client.connect();

// üì¶ Database –±–∞ Collection —Ç–æ–¥–æ—Ä—Ö–æ–π–ª–æ—Ö
const db = client.db("ubcarpool"); // —á–∏–Ω–∏–π —Ö“Ø—Å—Å—ç–Ω –Ω—ç—Ä, –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä “Ø“Ø—Å–Ω—ç
const collection = db.collection("kv_store");

// ‚úÖ Key-value set
export const set = async (key: string, value: any): Promise<void> => {
  await collection.updateOne(
    { key },
    { $set: { key, value } },
    { upsert: true }
  );
};

// ‚úÖ Get by key
export const get = async (key: string): Promise<any> => {
  const doc = await collection.findOne({ key });
  return doc?.value ?? null;
};

// ‚úÖ Delete key
export const del = async (key: string): Promise<void> => {
  await collection.deleteOne({ key });
};

// ‚úÖ Get multiple by prefix
export const getByPrefix = async (prefix: string): Promise<any[]> => {
  const docs = await collection
    .find({ key: { $regex: `^${prefix}` } })
    .toArray();
  return docs.map((d) => d.value);
};
