import { useState, useEffect } from "react";
import { MapView } from "../shared/MapView";
import { Search, Clock, TrendingUp, Bell } from "lucide-react";
import { API_BASE_URL } from "../../utils/api";

interface PassengerDashboardProps {
  user?: any;
  onFindRoute: () => void;
}

export function PassengerDashboard({
  user,
  onFindRoute,
}: PassengerDashboardProps) {
  const [storedUser, setStoredUser] = useState<any>(user || null);
  const [availableRoutes, setAvailableRoutes] = useState<any[]>([]);
  const [stats, setStats] = useState({ totalRides: 0, totalSpent: 0 });
  const [loading, setLoading] = useState(true);

  // ‚úÖ Load user from localStorage if not passed from props
  useEffect(() => {
    if (!user) {
      const localUser = localStorage.getItem("user");
      if (localUser) {
        setStoredUser(JSON.parse(localUser));
      }
    }
  }, [user]);

  // ‚úÖ Once user is known, load dashboard data from MongoDB
  useEffect(() => {
    if (storedUser?.id) {
      loadDashboardData(storedUser.id);
    }
  }, [storedUser?.id]);

  const loadDashboardData = async (userId: string) => {
    setLoading(true);
    try {
      const token = localStorage.getItem("token");
      const response = await fetch(
        `${API_BASE_URL}/passenger/dashboard?userId=${userId}`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        }
      );

      if (!response.ok) {
        console.error("‚ùå Server Error:", response.statusText);
        return;
      }

      const data = await response.json();
      setAvailableRoutes(data.nearbyRoutes || []);
      setStats(data.stats || { totalRides: 0, totalSpent: 0 });
    } catch (err) {
      console.error("‚ùå Failed to load dashboard:", err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="pb-20 px-4 pt-6 max-w-md mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div>
          <h2 className="text-lg font-semibold">–°–∞–π–Ω –±–∞–π–Ω–∞ —É—É,</h2>
          <p className="text-muted-foreground">
            {storedUser?.name || "–•—ç—Ä—ç–≥–ª—ç–≥—á"}
          </p>
        </div>
        <button className="relative p-2 rounded-full bg-accent hover:bg-accent/80 transition-colors">
          <Bell className="w-6 h-6" />
        </button>
      </div>

      {/* Search Card */}
      <button
        onClick={onFindRoute}
        className="w-full bg-gradient-to-r from-primary to-primary/80 text-primary-foreground rounded-2xl p-6 mb-6 text-left hover:opacity-90 transition-opacity"
      >
        <div className="flex items-center gap-3 mb-2">
          <Search className="w-6 h-6" />
          <h3 className="text-white font-medium">–ú–∞—Ä—à—Ä—É—Ç —Ö–∞–π—Ö</h3>
        </div>
        <p className="text-sm opacity-90">–•–∞–∞—à–∞–∞ —è–≤–∞—Ö –≥—ç–∂ –±–∞–π–Ω–∞?</p>
      </button>

      {/* Stats Section */}
      {loading ? (
        <p className="text-center text-muted-foreground mb-6">–£–Ω—à–∏–∂ –±–∞–π–Ω–∞...</p>
      ) : (
        <div className="grid grid-cols-2 gap-4 mb-6">
          <div className="bg-card border border-border rounded-2xl p-4">
            <div className="flex items-center gap-2 mb-2">
              <TrendingUp className="w-5 h-5 text-primary" />
              <span className="text-sm text-muted-foreground">–ù–∏–π—Ç –∞—è–ª–∞–ª</span>
            </div>
            <p className="text-3xl font-semibold">{stats.totalRides}</p>
          </div>

          <div className="bg-card border border-border rounded-2xl p-4">
            <div className="flex items-center gap-2 mb-2">
              <span className="text-xl">üí∞</span>
              <span className="text-sm text-muted-foreground">–ù–∏–π—Ç –∑–∞—Ä–¥–∞–ª</span>
            </div>
            <p className="text-3xl font-semibold">
              {(stats.totalSpent / 1000).toFixed(0)}k‚ÇÆ
            </p>
          </div>
        </div>
      )}

      {/* Map Section */}
      <div className="mb-6">
        <h3 className="mb-3 font-medium">–¢–∞–Ω—ã –±–∞–π—Ä—à–∏–ª</h3>
        <MapView height="h-48" />
      </div>

      {/* Nearby Routes */}
      <div>
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-medium">–û–π—Ä–æ–ª—Ü–æ–æ—Ö –º–∞—Ä—à—Ä—É—Ç—É—É–¥</h3>
          <button
            onClick={onFindRoute}
            className="text-sm text-primary hover:underline"
          >
            –ë“Ø–≥–¥–∏–π–≥ —Ö–∞—Ä–∞—Ö
          </button>
        </div>

        {loading ? (
          <p className="text-center text-muted-foreground">–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...</p>
        ) : availableRoutes.length === 0 ? (
          <div className="bg-card border border-border rounded-2xl p-6 text-center">
            <p className="text-muted-foreground">
              –û–¥–æ–æ–≥–æ–æ—Ä –±–æ–ª–æ–º–∂—Ç–æ–π –º–∞—Ä—à—Ä—É—Ç –±–∞–π—Ö–≥“Ø–π
            </p>
          </div>
        ) : (
          <div className="space-y-3">
            {availableRoutes.slice(0, 3).map((route: any, idx: number) => (
              <RouteCard key={idx} route={route} onSelect={onFindRoute} />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

function RouteCard({ route, onSelect }: { route: any; onSelect: () => void }) {
  return (
    <button
      onClick={onSelect}
      className="w-full bg-card border border-border rounded-2xl p-4 text-left hover:bg-accent transition-colors"
    >
      <div className="flex items-start justify-between mb-2">
        <div className="flex-1">
          <p className="text-sm text-muted-foreground">
            {route.startPoint || "–ë–∞—è–Ω–∑“Ø—Ä—Ö"} ‚Üí {route.endPoint || "–°“Ø—Ö–±–∞–∞—Ç–∞—Ä"}
          </p>
          <div className="flex items-center gap-3 mt-2 text-sm">
            <span className="flex items-center gap-1">
              <Clock className="w-4 h-4" />
              {route.departureTime || "08:00"}
            </span>
            <span className="text-muted-foreground">
              {route.seatsLeft || 3} —Å—É—É–¥–∞–ª “Ø–ª–¥—Å—ç–Ω
            </span>
          </div>
        </div>
        <div className="text-right">
          <p className="text-primary font-medium">{route.price || "5,000"}‚ÇÆ</p>
          <p className="text-xs text-muted-foreground">
            ~{route.eta || "25"} –º–∏–Ω
          </p>
        </div>
      </div>
    </button>
  );
}
